name: Update gold/silver (GoldAPI only, 2x/weekday, simple rates.json)

on:
  schedule:
    - cron: "30 3 * * 1-5"     # 09:00 IST Mon–Fri
    - cron: "30 12 * * 1-5"    # 18:00 IST Mon–Fri
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Kolkata"
      OUNCE_TO_GRAM: "31.1034768"
      # parity envs retained but not required for this minimal output
      PURITY_NUM: "995"
      PURITY_DEN: "999"
      DUTY: "0.065"
      BANK: "0.001"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Fetch via GoldAPI (XAU & XAG in INR)
        id: goldapi
        env:
          GOLDAPI_KEY: ${{ secrets.GOLDAPI_KEY }}
          OUNCE_TO_GRAM: ${{ env.OUNCE_TO_GRAM }}
        run: |
          set -euo pipefail
          [ -z "${GOLDAPI_KEY:-}" ] && { echo "No GOLDAPI_KEY"; exit 1; }

          XAU_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" "https://www.goldapi.io/api/XAU/INR")
          XAG_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" "https://www.goldapi.io/api/XAG/INR")

          # Prefer INR/gram; else derive from INR/oz
          G24=$(echo "$XAU_JSON" | jq -r '.price_gram_24k // empty')
          if [ -z "$G24" ] || [ "$G24" = "null" ]; then
            POZ_G=$(echo "$XAU_JSON" | jq -r '.price // empty')  # ₹/oz
            [ -z "$POZ_G" ] && { echo "GoldAPI missing gold price"; exit 1; }
            G24=$(echo "scale=8; $POZ_G / $OUNCE_TO_GRAM" | bc -l)
          fi

          # Silver: prefer price_gram_999, else derive from oz
          SGR=$(echo "$XAG_JSON" | jq -r '.price_gram_999 // empty')
          if [ -z "$SGR" ] || [ "$SGR" = "null" ]; then
            POZ_S=$(echo "$XAG_JSON" | jq -r '.price // empty') || true
            if [ -n "${POZ_S:-}" ]; then
              SGR=$(echo "scale=8; $POZ_S / $OUNCE_TO_GRAM" | bc -l)
            else
              SGR=""
            fi
          fi

          TS=$(echo "$XAU_JSON" | jq -r '.timestamp // empty')

          # Normalize: round to integers for display
          # gold24k as integer rupees per gram
          gold24k_int=$(printf "%.0f" "$(echo "$G24" | awk '{printf "%f",$0}')")
          silver_int=""
          if [ -n "${SGR}" ]; then
            silver_int=$(printf "%.0f" "$(echo "$SGR" | awk '{printf "%f",$0}')")
          fi

          # Choose readable source label
          SRC="GoldAPI (spot per gram, INR)"

          echo "gold24k=${gold24k_int}" >> "$GITHUB_OUTPUT"
          echo "silver=${silver_int}" >> "$GITHUB_OUTPUT"
          echo "timestamp=${TS}" >> "$GITHUB_OUTPUT"
          echo "source=${SRC}" >> "$GITHUB_OUTPUT"

      - name: Write rates.json (jq)
        run: |
          set -euo pipefail
          mkdir -p data

          # inputs from previous step
          GOLD24='${{ steps.goldapi.outputs.gold24k }}'
          SILVER='${{ steps.goldapi.outputs.silver }}'
          TS='${{ steps.goldapi.outputs.timestamp }}'
          SRC='${{ steps.goldapi.outputs.source }}'

          # Compute 22k (round)
          # if GOLD24 empty -> set 0
          if [ -z "${GOLD24:-}" ] || [ "${GOLD24}" = "null" ]; then
            GOLD24=0
          fi

          GOLD22=$(awk -v g="${GOLD24}" 'BEGIN{ printf("%d", (g * 0.9167) + 0.5) }')
          SILVAL=0
          if [ -n "${SILVER:-}" ] && [ "${SILVER}" != "null" ]; then
            SILVAL=$(printf "%d" "${SILVER}")
          fi

          UPDATED=$(TZ=Asia/Kolkata date "+%Y-%m-%d %H:%M IST")

          jq -n \
            --argjson gold24 "${GOLD24}" \
            --argjson gold22 "${GOLD22}" \
            --argjson silver "${SILVAL}" \
            --arg updated "${UPDATED}" \
            --arg source "${SRC}" \
            '{
              gold24k: $gold24,
              gold22k: $gold22,
              silver: $silver,
              updated: $updated,
              source: $source
            }' > data/rates.json

      - name: Commit & push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/rates.json
          git commit -m "Auto-update simple rates (gold24k,gold22k,silver,updated,source)" || echo "No changes"
          git push
