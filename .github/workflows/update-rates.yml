name: Update gold/silver (MCX â†’ rates.json)

on:
  schedule:
    - cron: "30 3 * * 1-5"
    - cron: "30 12 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-build:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Kolkata"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq and bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Fetch MCX rates via Metals.dev
        id: metals
        env:
          METALS_API_KEY: ${{ secrets.METALS_API_KEY }}
        run: |
          set -euo pipefail
          RESP=$(curl -sSf -G "https://api.metals.dev/v1/metal/authority" \
            --data-urlencode "api_key=${METALS_API_KEY}" \
            --data-urlencode "authority=mcx" \
            --data-urlencode "currency=INR" \
            --data-urlencode "unit=g")

          echo "$RESP" > /tmp/mcx.json
          echo "mcx_gold=$(jq -r '.rates.mcx_gold' /tmp/mcx.json)" >> $GITHUB_OUTPUT
          echo "mcx_silver=$(jq -r '.rates.mcx_silver' /tmp/mcx.json)" >> $GITHUB_OUTPUT
          echo "timestamp=$(jq -r '.timestamp' /tmp/mcx.json)" >> $GITHUB_OUTPUT

      - name: Generate rates.json
        run: |
          set -euo pipefail

          MCX_GOLD="${{ steps.metals.outputs.mcx_gold }}"
          MCX_SILVER="${{ steps.metals.outputs.mcx_silver }}"
          TS="${{ steps.metals.outputs.timestamp }}"
          SRC="Metals.dev (MCX INR/g)"

          mkdir -p data
          rm -f tmp_rate_*.json || true

          # GOLD per 10g / SILVER per 1kg
          GOLD_PER_10G=$(awk "BEGIN{printf \"%.2f\", $MCX_GOLD * 10}")
          SILVER_PER_1KG=$(awk "BEGIN{printf \"%.2f\", $MCX_SILVER * 1000}")

          compute_line() {
            local key="$1"; local label="$2"; local base="$3"; local purity="$4"
            local margin="$5"; local bspread="$6"; local sspread="$7"; local unit="$8"

            raw=$(awk "BEGIN{printf \"%.2f\", $base * ($purity/100)}")
            mid=$(awk "BEGIN{printf \"%.2f\", $raw * (1 + $margin)}")
            buy=$(awk "BEGIN{printf \"%.0f\", $mid * (1 - $bspread)}")
            sell=$(awk "BEGIN{printf \"%.0f\", $mid * (1 + $sspread)}")

            jq -n \
              --arg key "$key" \
              --arg label "$label" \
              --arg unit "$unit" \
              --argjson raw_base "$raw" \
              --argjson mid "$mid" \
              --argjson buy "$buy" \
              --argjson sell "$sell" \
              '{key:$key,label:$label,unit:$unit,raw_base:$raw_base,mid:$mid,buy:$buy,sell:$sell}'
          }

          # GOLD MAX & SILVER MAX (top items)
          compute_line "gold_max" "GOLD MAX (MCX GOLD)" "$GOLD_PER_10G" 99.5 0 0 0 "10 g" > tmp_rate_gold_max.json
          compute_line "silver_max" "SILVER MAX (MCX SILVER)" "$SILVER_PER_1KG" 99.9 0 0 0 "1 kg" > tmp_rate_silver_max.json

          # GOLD 99.50 CASH / RTGS
          GOLD_995_RATE=$(awk "BEGIN{printf \"%.6f\", $MCX_GOLD * 0.995}")
          GOLD_995_PER_10G=$(awk "BEGIN{printf \"%.2f\", $GOLD_995_RATE * 10}")

          compute_line "gold_99_50_cash" "GOLD 99.50 CASH BHAV" "$GOLD_PER_10G" 99.5 0.06 0.0025 0.0025 "10 g" > tmp_rate_gold_cash.json
          compute_line "gold_99_50_rtgs" "GOLD 99.50 RTGS BHAV 10-20-50 GM" "$GOLD_995_PER_10G" 100 0.04 0.003 0.003 "10 g" > tmp_rate_gold_rtgs.json

          # SILVER REFINERY (per KG)
          SILVER_REFINERY=$(awk "BEGIN{printf \"%.0f\", 1000 * 0.99 * $MCX_SILVER}")
          jq -n \
            --arg key "silver_refinery" \
            --arg label "SILVER REFINERY 99 PLUS CASH BHAV" \
            --arg unit "1 kg" \
            --argjson buy "$SILVER_REFINERY" \
            --argjson sell "$SILVER_REFINERY" \
            '{key:$key,label:$label,unit:$unit,buy:$buy,sell:$sell}' \
            > tmp_rate_silver_refinery.json

          # SILVER 999 SILCUT CASH
          compute_line "silver_999_cash" "SILVER 999 SILCUT CASH BHAV" "$SILVER_PER_1KG" 99.9 0.03 0.003 0.003 "1 kg" > tmp_rate_silver_cash.json

          # SILVER 999 RTGS (1 KG)
          SILVER_RTGS=$(awk "BEGIN{printf \"%.0f\", ($MCX_SILVER * 1000) * 1.03}") # GST 3%
          jq -n \
            --arg key "silver_999_rtgs" \
            --arg label "SILVER SILCUT 999 RTGS BHAV 1 KG" \
            --arg unit "1 kg" \
            --argjson buy "$SILVER_RTGS" \
            --argjson sell "$SILVER_RTGS" \
            '{key:$key,label:$label,unit:$unit,buy:$buy,sell:$sell}' \
            > tmp_rate_silver_rtgs.json

          # BASIC GOLD PRICES (PER GRAM)
          for k in 22 20 18 14 10; do
            VAL=$(awk "BEGIN{printf \"%.2f\", $MCX_GOLD * ($k/24) * 10}")
            jq -n \
              --arg key "gold_${k}k_basic" \
              --arg label "${k} K GOLD BASIC PRICE (GST & MAKING EXTRA)" \
              --arg unit "10 g" \
              --argjson buy "$VAL" \
              --argjson sell "$VAL" \
              '{key:$key,label:$label,unit:$unit,buy:$buy,sell:$sell}' \
              > tmp_rate_gold_${k}.json
          done

          jq -s '.' tmp_rate_*.json > data/tmp.json

          UPDATED=$(TZ=Asia/Kolkata date "+%Y-%m-%d %H:%M IST")
          jq --arg updated "$UPDATED" --arg ts "$TS" --arg source "$SRC" \
            '{updated:$updated,timestamp:$ts,source:$source,items:.}' \
            data/tmp.json > data/rates.json

          rm -f tmp_rate_*.json data/tmp.json

      - name: Commit & push data/rates.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/rates.json
          git commit -m "Auto-update MCX-only gold & silver rates" || echo "No changes"
          git push
